#SAML Reference

##**Overview**

MPass currently supports only one standard way of integration for SSO and SLO: SAML 2.0 via HTTP POST binding. Although MPass also supports HTTP Redirect binding, its usage is not recommended.

To completely understand how to integrate with MPass, **please read [SAML Binding, 3.5]**.

The above reference describes how to correctly generate, encode and submit requests, as well as how to handle errors and responses.

MPass uses AuthnRequest/Response and LogoutRequest/LogoutResponse pairs to implement SSO and SLO.

For a detailed description of security related aspects, **please read [SAML Security Considerations, 6.4]**.

##**SAML Structures**

This section describes all the involved SAML structures in details.

###**AuthnRequest structure**

An authentication request, referred to as AuthnRequest, is generated by Service and submitted to MPass via user’s browser to direct him for authentication.

Here is an example of AuthnRequest generated by .NET sample.

=== "AuthnRequest"

    ```xml
    <saml2p:AuthnRequest ID="_92a43de2-b6ab-460c-abe5-8580f828bf76" Version="2.0" IssueInstant="2014-10-20T08:26:26.9933782Z" Destination="https://mpass.staging.egov.md/login/saml" AssertionConsumerServiceURL="http://localhost:50341/Account/Acs"
    xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion">
      <saml2:Issuer>http://sample.testmpass.gov.md</saml2:Issuer>
      <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
        <!-- ... -->
      </Signature>
      <saml2p:NameIDPolicy AllowCreate="true" />
    </saml2p:AuthnRequest>
    ```

The following table describes structure attributes.

<table>
  <thead>
    <tr>
      <th><strong>Element or @Attribute</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Value</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>@ID</td>
      <td>any unique string</td>
      <td>required</td>
      <td>Generated by Service. This value will be returned back by MPass in Response/@InResponseTo attribute and can be checked in order to stop replay attacks.</td>
    </tr>
    <tr>
      <td>@Version</td>
      <td>Constant</td>
      <td>2.0</td>
      <td>This value is required and must be set to “2.0”.</td>
    </tr>
    <tr>
      <td>@Destination</td>
      <td>URL</td>
      <td>required</td>
      <td>Must be set to MPass SSO URL.</td>
    </tr>
    <tr>
      <td>@AssertionConsumerServiceURL</td>
      <td>URL</td>
      <td>optional, default value: set in Service settings</td>
      <td>This URL is used by MPass to submit the SAML Response.</td>
    </tr>
    <tr>
      <td>@ProtocolBinding (not present in above example)</td>
      <td>URI</td>
      <td>optional, default: urn:oasis:names:tc:SAML: 2.0:bindings:HTTP-POST</td>
      <td>URI reference that identifies the SAML protocol binding to be used when returning the Response. Although MPass supports HTTP POST and Redirect binding, Redirect binding is not recommended.</td>
    </tr>
    <tr>
      <td>@ForceAuthn (not present in above example)</td>
      <td>bool</td>
      <td>optional, default: false</td>
      <td>When set to “true”, MPass will required the user to authenticate even if user already has a valid and authenticated MPass session.</td>
    </tr>
    <tr>
      <td>@IsPassive (not present in above example)</td>
      <td>bool</td>
      <td>optional, default: false</td>
      <td>When set to “true”, MPass will not interact with the user and submit the SAML Response with current user authentication status.</td>
    </tr>
    <tr>
      <td>Issuer</td>
      <td>string</td>
      <td>required</td>
      <td>Represents the issuer of this AuthnRequest, usually as an URL.</td>
    </tr>
    <tr>
      <td>Signature</td>
      <td>Xml</td>
      <td>required</td>
      <td>Contains the signature of this AuthnRequest, applied using the private key of the Issuer.</td>
    </tr>
    <tr>
      <td>NameIDPolicy</td>
      <td>Xml</td>
      <td>required</td>
      <td>MPass currently ignore this policy element, but all Services are required to include it (exactly as in example above, including AllowCreate attribute) for compatibility.</td>
    </tr>
  </tbody>
</table>

###**Response structure**

MPass is generating a successful (i.e. user authenticated) or failed (i.e. user failed or cancelled the authentication) SAML Response in response to AuthnRequest. The Response is submitted to the Service via user’s browser in the same way as the request. Before handling the response, Service must validate it accordingly.

Here is an example of successful SAML Response returned by MPass in response to the above AuthnRequest.

=== "AuthnResponse"

    ```xml
    <samlp:Response ID="_7722d8dc-3401-4e16-b789-8c4db923ea86" InResponseTo="_7b874d06-2b14-4dbe-b177-3a70140a5b66" Version="2.0" IssueInstant="2014-10-20T08:39:48.786Z" Destination="http://localhost:50341/Account/Acs" Consent="urn:oasis:names:tc:SAML:2.0:consent:prior"
    xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">
      <saml:Issuer>http://devmpass.gov.md</saml:Issuer>
      <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">        <!-- ... --></Signature>
      <samlp:Status>
          <samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success" />
      </samlp:Status>
      <saml:Assertion Version="2.0" ID="_b3ef6fcb-8db0-44dc-9a96-a3ca008ec55c" IssueInstant="2014-10-20T08:39:48.786Z">
          <saml:Issuer>http://devmpass.gov.md</saml:Issuer>
          <saml:Subject>
              <saml:NameID>admin</saml:NameID>
              <saml:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
                  <saml:SubjectConfirmationData NotOnOrAfter="2014-10-20T08:49:48.786Z" Recipient="http://localhost:50341/Account/Acs" InResponseTo="_7b874d06-2b14-4dbe-b177-3a70140a5b66" />
              </saml:SubjectConfirmation>
          </saml:Subject>
          <saml:Conditions NotOnOrAfter="2014-10-20T08:49:48.786Z">
              <saml:AudienceRestriction>
                  <saml:Audience>http://sample.testmpass.gov.md</saml:Audience>
              </saml:AudienceRestriction>
          </saml:Conditions>
          <saml:AuthnStatement AuthnInstant="2014-10-20T08:38:19.703Z" SessionIndex="c5b3376a-a437-4b9c-addf-a3ca008e5883" SessionNotOnOrAfter="2014-10-20T08:48:19.697Z">
              <saml:SubjectLocality Address="127.0.0.1" />
              <saml:AuthnContext>
                  <saml:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</saml:AuthnContextClassRef>
              </saml:AuthnContext>
          </saml:AuthnStatement>
          <saml:AttributeStatement>
              <saml:Attribute Name="FirstName">
                  <saml:AttributeValue>Admin</saml:AttributeValue>
              </saml:Attribute>
              <saml:Attribute Name="LastName">
                  <saml:AttributeValue>Adminovich</saml:AttributeValue>
              </saml:Attribute>
          </saml:AttributeStatement>
      </saml:Assertion>
    </samlp:Response>
    ```

The following table describes structure attributes.

<table>
  <thead>
    <tr>
      <th><strong>Element or @Attribute</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Value</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>@ID</td>
      <td>any unique string</td>
      <td>required</td>
      <td>Generated by MPass, provided for traceability purposes.</td>
    </tr>
    <tr>
      <td>@InResponseTo</td>
      <td>string</td>
      <td>required</td>
      <td>This value is set to the incoming AuthnRequest/@ID. Service can use it for traceability or check it to stop authentications by 3rd parties even with a stolen Service private key.</td>
    </tr>
    <tr>
      <td>@Version</td>
      <td>constant</td>
      <td>2.0</td>
      <td>This value is required and must be set to “2.0”.</td>
    </tr>
    <tr>
      <td>@IssueInstant</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>The instant of time when this Response was generated. To minimize the risk of replays, Service must not accept old responses.</td>
    </tr>
    <tr>
      <td>@Destination</td>
      <td>URL</td>
      <td>required</td>
      <td>The URL of the destination for this Response. Can be checked by Service to stop Responses aimed for a different Service or deployment environment.</td>
    </tr>
    <tr>
      <td>@Consent</td>
      <td>URI</td>
      <td>optional</td>
      <td>Additional information regarding user consent. Can be set to explicit (the consent was explicitly given during the authentication) or prior (the consent was persisted during previous authentication).</td>
    </tr>
    <tr>
      <td>Issuer</td>
      <td>string</td>
      <td>required</td>
      <td>Represents the issuer of this Response, which is obviously one of the MPass instances (dev, test or production environment).</td>
    </tr>
    <tr>
      <td>Signature</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains the MPass signature of this Response, applied using MPass the private key. Service must verify this signature.</td>
    </tr>
    <tr>
      <td>Status</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains Response status details.</td>
    </tr>
    <tr>
      <td>Status / StatusCode / @Value</td>
      <td>string</td>
      <td>required</td>
      <td>Specifies the top-level status of this Response. Possible values are Success (authentication succeeded), Requestor (failure on Service side), Responder (failure on MPass or user side) and VersionMismatch. See [SAML Core, 3.2.2.2].</td>
    </tr>
    <tr>
      <td>Status / StatusCode / StatusCode / @Value</td>
      <td>string</td>
      <td>optional</td>
      <td>Second-level status code that specifies the reason of status. See [SAML Core, 3.2.2.2].</td>
    </tr>
    <tr>
      <td>Status / StatusMessage</td>
      <td>string</td>
      <td>optional</td>
      <td>Additional human-readable message related to Response status.</td>
    </tr>
    <tr>
      <td>Assertion</td>
      <td>xml</td>
      <td>included in successful Response</td>
      <td>SAML Assertion that includes the details of the authentication, authentication conditions and authenticated identity. If required by Service, MPass can sign this similarly to the whole Response.</td>
    </tr>
    <tr>
      <td>Assertion / @ID</td>
      <td>any unique string</td>
      <td>required</td>
      <td>Specifies the ID of this Assertion.</td>
    </tr>
    <tr>
      <td>Assertion / @IssueInstant</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>The instant of time when this Assertion was generated.</td>
    </tr>
    <tr>
      <td>Assertion / Issuer</td>
      <td>string</td>
      <td>required</td>
      <td>Represents the issuer of this Assertion, which is obviously one of the MPass instances (dev, test or production environment).</td>
    </tr>
    <tr>
      <td>Assertion / Subject</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains details of authenticated identity (i.e. its subject) and authentication confirmation.</td>
    </tr>
    <tr>
      <td>Assertion / Subject / NameID</td>
      <td>string</td>
      <td>required</td>
      <td>Authenticated identity name identifier. This is usually the IDNP of the authenticated resident, but it can also be an unique username of MPass user.</td>
    </tr>
    <tr>
      <td>Assertion / Subject / SubjectConfirmation / SubjectConfirmationData / @Recipient</td>
      <td>URL</td>
      <td>required</td>
      <td>Specifies the expected recipient of this Assertion. Same as Response/@Destination. Required by SAML standard.</td>
    </tr>
    <tr>
      <td>Assertion / Subject / SubjectConfirmation / SubjectConfirmationData / @InResponseTo</td>
      <td>string</td>
      <td>required</td>
      <td>Same as Response/@InResponseTo. Required by SAML standard.</td>
    </tr>
    <tr>
      <td>Assertion / Conditions</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains conditions under which this Assertion must be considered.</td>
    </tr>
    <tr>
      <td>Assertion / Conditions / @NotOnOrAfter</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>Specifies the time until this Assertion can be considered as valid.</td>
    </tr>
    <tr>
      <td>Assertion / Conditions / AudienceRestriction / Audience</td>
      <td>string</td>
      <td>required, could be many</td>
      <td>Specifies the expected audience for this Assertion. Service must check for match with its AuthnRequest/Issuer. Note that an Assertion can have many audiences.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains authentication details.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement / @AuthnInstant</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>Specifies the exact time instant of authentication.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement / @SessionIndex</td>
      <td>string</td>
      <td>required</td>
      <td>Specifies the ID of the MPass session under which the identity was authenticated. Must be used in LogoutRequest/SessionIndex to specify the exact session to log out from.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement / @SessionNotOnOrAfter</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>Specifies the time until MPass session is valid.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement / SubjectLocality / @Address</td>
      <td>IP address</td>
      <td>optional</td>
      <td>Specifies the IP address of the client that performed the authentication as seen by MPass.</td>
    </tr>
    <tr>
      <td>Assertion / AuthnStatement / AuthnContext / AuthnContextClassRef</td>
      <td>string</td>
      <td>optional</td>
      <td>Specifies the instrument or method used for authentication. See [SAML Core, 2.7.2.2] and [SAML Authn Context, 3.4].</td>
    </tr>
    <tr>
      <td>Assertion / AttributeStatement</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains authoritative attribute values (i.e. claims) that represent the, are assigned or associated with authenticated identity.</td>
    </tr>
    <tr>
      <td>Assertion / AttributeStatement / Attribute / @Name</td>
      <td>string</td>
      <td>required</td>
      <td>The name of the provided attribute.</td>
    </tr>
    <tr>
      <td>Assertion / AttributeStatement / Attribute / AttributeValue</td>
      <td>string or xml</td>
      <td>optional, could be many</td>
      <td>Contains the value of the attribute. Note that some attributes can naturally have multiple values (e.g. identity Role in some Service).</td>
    </tr>
  </tbody>
</table>

###**Response structure**

A LogoutRequest is generated either by a Service (as a result of user explicit request to logout) or MPass (in order to perform single logout, as a result of another service requesting user logout in the same authentication session or direct user logout in MPass UI).

Here is an example of LogoutRequest generated by .NET sample.

=== "LogoutRequest"

    ```xml
    <saml2p:LogoutRequest ID="_bdeed8e2-5c79-4d5b-8f93-2620f1219753" Version="2.0" IssueInstant="2014-10-20T08:51:44.8184811Z" Destination="http://devmpass.gov.md/logout/saml"
    xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion">
      <saml2:Issuer>http://sample.testmpass.gov.md</saml2:Issuer>
      <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
        <!-- ... -->
      </Signature>
      <saml2:NameID>admin</saml2:NameID>
      <saml2p:SessionIndex>ae94d066-67ba-4296-b149-a3ca0091b24e</saml2p:SessionIndex>
    </saml2p:LogoutRequest>
    ```

The following table describes structure attributes.

<table>
  <thead>
    <tr>
      <th><strong>Element or @Attribute</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Value</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>@ID</td>
      <td>any unique string</td>
      <td>required</td>
      <td>Generated by MPass/Service, provided for traceability purposes.</td>
    </tr>
    <tr>
      <td>@InResponseTo</td>
      <td>string</td>
      <td>required</td>
      <td>This value is set to the incoming LogoutRequest/@ID. The requesting party can use it for traceability or check it to stop authentications by 3rd parties even with a stolen party’s private key.</td>
    </tr>
    <tr>
      <td>@Version</td>
      <td>constant</td>
      <td>2.0</td>
      <td>This value is required and must be set to “2.0”.</td>
    </tr>
    <tr>
      <td>Issuer</td>
      <td>string</td>
      <td>required</td>
      <td>Represents the issuer of this LogoutResponse, usually as an URL.</td>
    </tr>
    <tr>
      <td>Signature</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains the signature of this LogoutRequest, applied using the private key of the Issuer.</td>
    </tr>
    <tr>
      <td>NameID</td>
      <td>string</td>
      <td>required</td>
      <td>Contains the username (usually IDNP) of the logged in user, as previously returned by MPass in Response/Assertion /Subject/NameID.</td>
    </tr>
    <tr>
      <td>SessionIndex</td>
      <td>string</td>
      <td>required</td>
      <td>Contains the ID of the session that was previously returned by MPass in Response/Assertion /AuthnStatement/@SessionIndex.</td>
    </tr>
  </tbody>
</table>

###**LogoutResponse structure**

A LogoutResponse is returned as a response to a LogoutRequest, either by MPass (in response to a Service request) or a service (as a response for single logout request from MPass).

Here is an example of successful LogoutResponse returned by MPass in response to the above LogoutRequest.

=== "LogoutResponse"

    ```xml
    <samlp:LogoutResponse ID="_34650a27-f348-41cc-a2ef-e481d89a727c" InResponseTo="_bdeed8e2-5c79-4d5b-8f93-2620f1219753" Version="2.0" IssueInstant="2014-10-20T08:52:13.207Z" Destination="http://localhost:50341/Account/AfterLogout"
    xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">
      <saml:Issuer>http://devmpass.gov.md</saml:Issuer>
      <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
          <!-- ... -->
      </Signature>
      <samlp:Status>
          <samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success" />
      </samlp:Status>
    </samlp:LogoutResponse>
    ```

The following table describes structure attributes.

<table>
  <thead>
    <tr>
      <th><strong>Element or @Attribute</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Value</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>@ID</td>
      <td>any unique string</td>
      <td>required</td>
      <td>Generated by MPass or Service. This value will/must be returned back by MPass/Service in LogoutResponse/@InResponseTo attribute and can be checked in order to stop replay attacks.</td>
    </tr>
    <tr>
      <td>@Version</td>
      <td>constant</td>
      <td>2.0</td>
      <td>This value is required and must be set to “2.0”.</td>
    </tr>
    <tr>
      <td>@IssueInstant</td>
      <td>datetime</td>
      <td>required, value in UTC</td>
      <td>The instant of time when this LogoutResponse was generated. To minimize the risk of replays, requesting party must not accept old responses.</td>
    </tr>
    <tr>
      <td>@Destination</td>
      <td>URL</td>
      <td>required</td>
      <td>The URL of the destination for this LogoutResponse. Can be checked by requesting party to stop Responses aimed for a different party or deployment environment.</td>
    </tr>
     <tr>
      <td>Issuer</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains the signature of this LogoutResponse, applied using the private key of the Issuer.</td>
    </tr>
    <tr>
      <td>Signature</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains the signature of this LogoutResponse, applied using the private key of the Issuer.</td>
    </tr>
    <tr>
      <td>Status</td>
      <td>xml</td>
      <td>required</td>
      <td>Contains LogoutResponse status details.</td>
    </tr>
    <tr>
      <td>Status / StatusCode / @Value</td>
      <td>string</td>
      <td>required</td>
      <td>Specifies the top-level status of this LogoutResponse. Possible values are Success (logout succeeded), Requestor (failure on requesting side), Responder (failure on responder side) and VersionMismatch. See [SAML Core, 3.2.2.2].</td>
    </tr>
    <tr>
      <td>Status / StatusCode / StatusCode / @Value</td>
      <td>string</td>
      <td>optional</td>
      <td>Second-level status code that specifies the reason of status. See [SAML Core, 3.2.2.2].</td>
    </tr>
    <tr>
      <td>Status / StatusMessage</td>
      <td>string</td>
      <td>optional</td>
      <td>Additional human-readable message related to LogoutResponse status.</td>
    </tr>
  </tbody>
</table>